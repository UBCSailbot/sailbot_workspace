name: Tests

on:
  push:
    branches:
      - main
      # sailbot_workspace only: raye branch used to run Raye's software
      - raye
  pull_request:
  # sailbot_workspace only: regression tests runs every Friday at 1:00am UTC
  schedule:
    - cron: '0 1 * * 5'
  workflow_dispatch:

# Cancel in-progress runs for the current workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # CI for all UBCSailbot repositories defined in one place
  # https://github.com/UBCSailbot/sailbot_workspace/blob/main/.github/workflows/test_definitions.yml
  test-definitions:
    # Runs another workflow, refer to
    # https://docs.github.com/en/actions/using-workflows/reusing-workflows#calling-a-reusable-workflow
    uses: UBCSailbot/sailbot_workspace/.github/workflows/test_definitions.yml@main
    with:
      repository: ${{ github.event.repository.name }}
      # VCS is used to clone all subteam repositories, so set to
      # true in subteam repositories and
      # false in sailbot_workspace
      disable-vcs: false
      # Rebuilds our docs site https://ubcsailbot.github.io/docs/
      # If the docs contains a snippet of a file in this repository, set to true
      rebuild-docs: true

  # Rebuilds our docs site https://ubcsailbot.github.io/docs/
  rebuild-docs-test:
    runs-on: ubuntu-latest
    steps:
    - name: Dispatch Docs Publish workflow
      # https://github.com/orgs/community/discussions/26323#discussioncomment-5600001
      run: |
          gh workflow run publish.yml -R UBCSailbot/docs
          sleep 5
          gh run watch -R UBCSailbot/docs $(gh run list -R UBCSailbot/docs -w publish.yml -L1 --json databaseId --jq '.[0].databaseId')
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
