{"version":3,"file":"formatters.js","sourceRoot":"","sources":["../../src/api/formatters.ts"],"names":[],"mappings":"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","sourcesContent":["import Formatter, { IFormatterStream } from '../formatter'\nimport { EventEmitter } from 'events'\nimport { EventDataCollector } from '../formatter/helpers'\nimport { ISupportCodeLibrary } from '../support_code_library_builder/types'\nimport { promisify } from 'util'\nimport { WriteStream as TtyWriteStream } from 'tty'\nimport FormatterBuilder from '../formatter/builder'\nimport fs from 'mz/fs'\nimport path from 'path'\nimport { IRunOptionsFormats } from './types'\nimport { ILogger } from '../logger'\nimport { mkdirp } from 'mkdirp'\n\nexport async function initializeFormatters({\n  env,\n  cwd,\n  stdout,\n  logger,\n  onStreamError,\n  eventBroadcaster,\n  eventDataCollector,\n  configuration,\n  supportCodeLibrary,\n}: {\n  env: NodeJS.ProcessEnv\n  cwd: string\n  stdout: IFormatterStream\n  stderr: IFormatterStream\n  logger: ILogger\n  onStreamError: () => void\n  eventBroadcaster: EventEmitter\n  eventDataCollector: EventDataCollector\n  configuration: IRunOptionsFormats\n  supportCodeLibrary: ISupportCodeLibrary\n}): Promise<() => Promise<void>> {\n  async function initializeFormatter(\n    stream: IFormatterStream,\n    target: string,\n    type: string\n  ): Promise<Formatter> {\n    stream.on('error', (error: Error) => {\n      logger.error(error.message)\n      onStreamError()\n    })\n    const typeOptions = {\n      env,\n      cwd,\n      eventBroadcaster,\n      eventDataCollector,\n      log: stream.write.bind(stream),\n      parsedArgvOptions: configuration.options,\n      stream,\n      cleanup:\n        stream === stdout\n          ? async () => await Promise.resolve()\n          : promisify<any>(stream.end.bind(stream)),\n      supportCodeLibrary,\n    }\n    if (type === 'progress-bar' && !(stream as TtyWriteStream).isTTY) {\n      logger.warn(\n        `Cannot use 'progress-bar' formatter for output to '${target}' as not a TTY. Switching to 'progress' formatter.`\n      )\n      type = 'progress'\n    }\n    return await FormatterBuilder.build(type, typeOptions)\n  }\n\n  const formatters: Formatter[] = []\n\n  formatters.push(\n    await initializeFormatter(stdout, 'stdout', configuration.stdout)\n  )\n\n  const streamPromises: Promise<void>[] = []\n\n  Object.entries(configuration.files).forEach(([target, type]) => {\n    streamPromises.push(\n      (async (target, type) => {\n        const absoluteTarget = path.resolve(cwd, target)\n\n        try {\n          await mkdirp(path.dirname(absoluteTarget))\n        } catch (error) {\n          logger.warn('Failed to ensure directory for formatter target exists')\n        }\n\n        const stream: IFormatterStream = fs.createWriteStream(null, {\n          fd: await fs.open(absoluteTarget, 'w'),\n        })\n        formatters.push(await initializeFormatter(stream, target, type))\n      })(target, type)\n    )\n  })\n\n  await Promise.all(streamPromises)\n\n  return async function () {\n    await Promise.all(formatters.map(async (f) => await f.finished()))\n  }\n}\n"]}