@startuml local_pathfinding_architecture_readable_midlevel

!define PROD_BG #E8F4F8
!define DEV_BG #F0E8F8
!define TEST_BG #F8F4E8

skinparam packageBorderColor #333
skinparam classBackgroundColor #ffffffff
skinparam classBorderColor #333

' === ROS Topics ===
package "ROS 2 Topics" {
    class ROSTopics {
        **Subscribed by Sailbot:**
        - ais_ships (ci.AISShips)
        - gps (ci.GPS)
        - global_path (ci.Path)
        - filtered_wind_sensor (ci.WindSensor)
        --
        **Published by Sailbot:**
        - desired_heading (ci.DesiredHeading)
        - local_path (ci.LPathData)
        --
        **Subscribed by SailbotObserver:**
        - local_path (ci.LPathData)
    }
}

' === Production Code ===
package "Production Code" PROD_BG {
    class Sailbot {
        **ROS 2 Node**
        --
        + ais_ships_callback()
        + gps_callback()
        + global_path_callback()
        + wind_sensor_callback()
        + publish_desired_heading()
        + publish_local_path_data()
    }

    class LocalPath {
        + set_path(LocalPathState)
        + update_waypoint_index()
        + calculate_desired_heading()
    }

    class LocalPathState {
        position, heading, speed
        ais_ships, global_path
        wind_speed, wind_direction
        obstacles
    }

    class OMPLPath {
        + solve_path()
        + get_solution_path()
        + configure_state_space()
    }

    class GlobalPath {
        + {static} get_path()
        + {static} interpolate_path()
        + {static} post_path_to_server()
    }
}

' === Development Code ===
package "Development Code" DEV_BG {
    class NodeNavigateObserver {
        **Spawns two processes:**
        1. SailbotObserver node
        2. Visualizer app
    }

    class SailbotObserver {
        **ROS 2 Node**
        --
        + local_path_callback()
        + queue.put(VisualizerState)
    }

    class VisualizerState {
        sailbot_lat_lon, sailbot_xy
        all_local_wp, global_path
        ais_ships, obstacles
    }

    class VisualizerDashApp {
        + dash_app()
        + live_plot()
        + update_plot()
        + live_update_callback()
    }
}

' === Test Code ===
package "Test Code" TEST_BG {
    class UnitTests {
        test_local_path.py
        test_ompl_path.py
        test_obstacles.py
        test_global_path.py
    }

    class MockNodes {
        node_mock_gps.py
        node_mock_ais.py
        node_mock_wind_sensor.py
        node_mock_global_path.py
    }
}

' === Production Relationships ===
Sailbot --> LocalPath : uses
Sailbot --> GlobalPath : uses
LocalPath --> LocalPathState : creates/manages
LocalPath --> OMPLPath : instantiates
OMPLPath --> LocalPath : returns solution

' === ROS Topic Relationships ===
Sailbot <-down- ROSTopics : subscribes from\n(ais, gps, global_path, wind)
Sailbot -down-> ROSTopics : publishes to\n(desired_heading, local_path)
SailbotObserver <-down- ROSTopics : subscribes from\n(local_path)

' === Development Relationships ===
NodeNavigateObserver --> SailbotObserver : spawns process
NodeNavigateObserver --> VisualizerDashApp : spawns process
SailbotObserver --> VisualizerState : creates
SailbotObserver --> VisualizerDashApp : sends data via queue
VisualizerDashApp --> VisualizerState : consumes state

' === Test Relationships ===
UnitTests -.-> Sailbot : tests
UnitTests -.-> LocalPath : tests
UnitTests -.-> OMPLPath : tests
UnitTests -.-> LocalPathState : tests
MockNodes -.-> Sailbot : provides test inputs
MockNodes -.-> ROSTopics : publishes mock data

' === Layout Control ===
Sailbot -[hidden]right- GlobalPath
LocalPath -[hidden]down- OMPLPath

SailbotObserver -[hidden]right- VisualizerDashApp
NodeNavigateObserver -[hidden]down- SailbotObserver

@enduml
